{"_default": {"1": {"jeffbski": {"issues": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/8", "title": "External handle is no longer being wrapped in an object for Node 0.11+, how can handle be validated?", "body": "In using the addonlayer, a handle (shim_ctx_t*) is returned and then passed around to be used in additional calls later.\n\nTo verify that all the proper values are being passed into our methods, we are doing JS validations on the parameters before calling back into the addon layer, however in Node 0.11.x the validations create a type error when they try to do `isNaN(handle)` or toString using `handle + ''`.\n\n```\nTypeError: Cannot convert object to primitive value\n```\n\nI originally had logged this issue against Node, but Fedor Indutny believes the error occurs because of the change in the addon layer, here \nhttps://github.com/tjfontaine/node-addon-layer/blob/master/src/shim.cc#L1645\n\nIt looks like this change was made purposefully for Node 0.11, so what do you recommend?\n\nI had added a failing test to demonstrate the problem at \nhttps://github.com/tjfontaine/node-addon-layer-test/pull/1\n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/8/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "NONE"}], "commits": [], "pull_requests": [], "issue_comments": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/comments/53628031", "body": "Original Node issue was here https://github.com/joyent/node/issues/7993\n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/comments/53628031/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "NONE"}], "commit_comments": [], "review_comments": []}, "tjfontaine": {"issues": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/7", "title": "some objects created in binding layer are immediately collected", "body": "for example `shim_buffer_new_external` may result in an immediate collection, the C++ destructor in the `shim_val_t` may be triggering that.\n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/7/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "OWNER"}], "commits": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/b4b67d11ed54ae6dec0c3a1e653c6be5042088c6", "message": "saner persistent handling, squash a potential leak"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/e1f96933a50539194dad204a8dd17a697cb8594d", "message": "support current master of node"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/b996071b8652c60f43e723451e70907c4fd43784", "message": "work around newer compilers for right now"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/621e3a86071d00b4a23bda228b5da03c55436706", "message": "Update for v0.11.10 support\n\nThis reverts commit 68b18e443727cdd2ae70fc87b9dd076a2829c973."}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/19f88ddc7f1f8f00825e54491ab955c28fb684da", "message": "use struct constructor not shim_val_alloc"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/947a69398e4edfed193d337a872ca148816c206f", "message": "update documentation to new api"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/3e65a2ab7d3918a3ce1b8944890c0a6c696570aa", "message": "make externals more useful on pre v0.11"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/0fdca463b2b0815fb4a2f77390a88d73a960fb81", "message": "allocate return values for you"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/43af96b7d838695a6cb131f678562458624fc305", "message": "unpack should allocate for you"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/5d772767a88f159ded365c2e803b4fdfd5aef84a", "message": "remove a few more ifdef's in favor of a define"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/dbbb2bf452977dfc004f25db76ddd60005391f79", "message": "add context to weak cb"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/94f79031de7b59faa3ca9c3cefe723afc73d2971", "message": "use new and delete"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/fef0cab353a92554e216351ed8ac55214960051a", "message": "fix master structure layout"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/96681c432c9daec23da9457cf7db2f2eaf20c274", "message": "use Handle on < 0.11"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/34d8a8d459ba06a7b6372f899a8b14f34eaef45a", "message": "avoid abusing pointers"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/1bfe187f99ca703c93699a1df1ca55a5faca65a5", "message": "update for v0.10"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/082f4ff1b0af20d03db58a4971e56880042f32a5", "message": "separate persistent and locals"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/908515d2da9bfb2eaa7efa173e0247e74132f855", "message": "when throwing abort early"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/4aeb4280c37ec713bd80ee55b87ae3e0bfa333ec", "message": "add SHIM_TYPE_BUFFER for value_is and unpack"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/3ae59b868145ae7342e12478f92403585a58152c", "message": "Pre v8 3.20 use External::[Un]Wrap"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/0416c82a64964263d888c8b269e22b96e5cf3848", "message": "supress redefinition warning NODE_MODULE_VERSION"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/4aa55208150488b2132782eb768f213c39336bb1", "message": "allow use arbitrary data on a function"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/1dab7d8a8d02755fac470bc2ac00f297c98f4e6d", "message": "document module design, and native handles"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/bcc120275bd67646f9d74775def77b21034553a9", "message": "better doxygen of core data types"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/4e03603b0cab656840867b4f8022dbea0a9b5e79", "message": "remove confusing SHIM_MODULE_VERSION"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/ae7c01131c2b3149883fdd667db5c6eba43b6bcf", "message": "rewrite memory management documentation"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/6be6ce3df0770995465f1a86c0bf97d221429e7b", "message": "refactor error to allow formatting"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/6e2cea691bde8d1e1b46d08394a1cd329fe2881f", "message": "Add start doxygen"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/c425d81966b69f4be73c0a11e19fe0190cd28f05", "message": "add make callback, refactor function calling"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/7f5d27635993f9d9b9f110646cfc25693e7b84f8", "message": "report type name in shim_unpack"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/f718c2725b37fa2b9586e4cd9afa8cc59e2ee17d", "message": "shim_throw_error is vargs, shim_unpack throws"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/4986ffafc41fc4f36c4a6db4e5c008016c68c9ee", "message": "bring the readme up to date slightly"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/6a123b25160c97d9ada55ec6f2ecb55ced977807", "message": "readd v0.11 support"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/e6827bfb9ecfd01064a11a6a2c7ff63c29fe6ba9", "message": "restore v0.8 compatibility"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/f9920d464eee8f68fb28ef8d93d03fa2c6eca07d", "message": "handle function calls that throw"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/2d4161d2a1056deed3f749a795f4853149e08bd1", "message": "saner return handling"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/a0ee6e071e49df0d75892ac4e6e5e18b8fc84222", "message": "handle nulls in argvs better"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/e22fd3f6b964fbc9cb5a1cc4206c2d363ccd9125", "message": "add shim_undefined and shim_null"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/ca6c51be4381eb28a46d2cd86c21aa0c76b01989", "message": "strdup string_value"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/03d4e3585fa2bd596bde312e70625f3f873684bb", "message": "not shim_new_object, but shim_obj_new"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/3bd657df73e6f1608499e366cdf3e8044f3579cb", "message": "slightly cleaner unpacking"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/7b76877e6feff813bf5e8db5e9811c12c791f55d", "message": "if there's no return value return undefined"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/6bbc6d1bd669ae508f0920a0e78b582e95c3f8e3", "message": "squash a few undeleted new's"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/03b43bee0db6db8ac80ed0f53113a3d403f49170", "message": "don't leak the argv"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/cb282af94e68cd83efd27bd8240622127f7dfa85", "message": "don't leak self"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/707b966f6235f1c8f29072a1377eac06da4620c1", "message": "don't leak functions on initialization"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/5a83f3fa8f5797de7ce86099f719be7c1489f6f3", "message": "don't use container_of for queued work"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/7f261fe25058ba0af9d8cbc9d04769e481faacfb", "message": "the great rewrite\n\ndrop the jsapi history, and make user responsible for memory\nmanagement of values they create"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/15252bff7b0db80b63df946705f639f0f2db6633", "message": "actually free the allocs set on cleanup"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/e898c7ccadc4042b1023a62ac6c43cfb011f3f34", "message": "use std::set for now instead of QUEUE"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/206a56f09283c3933cf9dfa9770e7c559ded2d1b", "message": "moving using statements into our namespace"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/a2c17e1e0c8c9d24aa571b378cc287b3741a55b0", "message": "make it compile with newer V8"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/4aef378a08a82ca56408251f431b5a28bed2c158", "message": "slightly cleaner version detection"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/9abb8cb7ed43cc9240cb2f615739bbe529cc2e20", "message": "fix compile on non-clang"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/9374363c08b43cde94581ffc2342d78e747df75e", "message": "add v0.8 support"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/23f3ba98e117a0450155c7f4e24073c6c1205263", "message": "more things"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/706fcff75813a5296ee8e69e7b66e522a8189a96", "message": "initial"}], "pull_requests": [], "issue_comments": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/comments/31415918", "body": "thanks these changes have been integrated.\n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/comments/31415918/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "OWNER"}], "commit_comments": [], "review_comments": []}, "notmatt": {"issues": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/4", "title": "Is it an external or an integer?", "body": "With node v0.10.17, ran into a problem where an external being passed back to JS-land was represented there as a number, and when passed back to the addon layer could not easily be recognized as an external. E.g.,\n\n```\n> var ndb = require('bindings')('ndb');\nundefined\n> var handle = ndb.init('core.69564', '');\nundefined\n> handle\n71161188\n> ndb.runcmd(handle, \"::status\")\nTypeError: Argument 0 not of type SHIM_TYPE_EXTERNAL\n    at repl:1:6\n    at REPLServer.self.eval (repl.js:110:21)\n```\n\nRelated addon code is:\n\n``` C\nshim_bool_t\nruncmd(shim_ctx_t* ctx, shim_args_t* args)\n{\n    uint32_t val;\n    shim_val_t* h = malloc(sizeof(shim_val_t*));\n    shim_val_t* c = malloc(sizeof(shim_val_t*));\n\n    int bufsz = 65536;\n    char *buf;\n    int rval;\n\n    shim_val_t* dresult;\n\n    if(!shim_unpack(ctx, args,\n       // SHIM_TYPE_UINT32, &val,\n       SHIM_TYPE_EXTERNAL, &h,\n       SHIM_TYPE_STRING, &c,\n       SHIM_TYPE_UNKNOWN))\n        return FALSE;\n\n    /* external passed back from JS can't be unpacked as an external.\n       v8 numbers unwrapped are shifted (apparently), so shift it back,\n       an boom, we've hacked ourselves the address we need. */\n    libmdb_t* mdbp = shim_external_valu(ctx, h);\n    const char *command = shim_string_value(c);\n```\n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/4/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "NONE"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/3", "title": "Err unpacking function args to SHIM_TYPE_FUNCTION", "body": "Ran into a blatant lie in the following error message:\n\n```\n/root/hackathon/ndb/dump.js:4\nndb.runcmd_async(handle, \"::status\", function(err, data) { console.log(\"in the\n    ^\nTypeError: Argument 2 not of type SHIM_TYPE_FUNCTION\n    at Object.<anonymous> (/root/hackathon/ndb/dump.js:4:5)\n    at Module._compile (module.js:456:26)\n```\n\nWhere argument 2 is clearly a function.\n\nThe related code (which is not free of other issues) is:\n\n```\nshim_bool_t\nruncmd_async(shim_ctx_t* ctx, shim_args_t* args)\n{\n    runcmd_baton_t* baton = malloc(sizeof(runcmd_baton_t));\n\n    uint32_t handle;\n    shim_val_t* command = malloc(sizeof(shim_val_t*));\n    shim_val_t* callback = malloc(sizeof(shim_val_t*));\n\n    if (!shim_unpack(ctx, args,\n       SHIM_TYPE_UINT32, &handle,\n       SHIM_TYPE_STRING, &command,\n       SHIM_TYPE_FUNCTION, &callback,\n       SHIM_TYPE_UNKNOWN))\n        return FALSE;\n\n    /* make these persistent, presumably? */\n    baton->handle = shim_persistent_new(ctx, shim_integer_uint(ctx, handle));\n    baton->command = shim_persistent_new(ctx, command);\n    baton->callback = shim_persistent_new(ctx, callback);\n\n    shim_queue_work((shim_work_cb)runcmd_work, (shim_after_work)runcmd_after, baton);\n    return TRUE;\n}\n```\n\nNB: building on SmartOS with node 0.10.17\n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/3/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "NONE"}], "commits": [], "pull_requests": [], "issue_comments": [], "commit_comments": [], "review_comments": []}, "jclulow": {"issues": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/2", "title": "Y U NO shim_boolean_new()", "body": "srsly\n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/2/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "NONE"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/1", "title": "shim_unpack() should allocate shim_val_t for you", "body": "It would be neat if this was the pattern, instead of what exists today:\n\n``` C\nint\nmyaddon_myfunc(shim_ctx_t *ctx, shim_args_t *args)\n{\n        shim_val_t *string0, *string1;\n\n        if (!shim_unpack(ctx, args,\n            SHIM_TYPE_STRING, &string0,\n            SHIM_TYPE_STRING, &string1,\n            SHIM_TYPE_UNKNOWN)) {\n                return (FALSE);\n        }\n\n        /* Do stuff with string0 and string1 ... */\n\n        shim_value_release(string0);\n        shim_value_release(string1);\n\n        return (TRUE);\n}\n```\n\nSpecifically: `shim_unpack()` should either:\n- succeed and allocate all of the required `shim_val_t`s\n- fail and allocate none of them (i.e. free any that it got part way through allocating prior to failure)\n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/1/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "NONE"}], "commits": [], "pull_requests": [], "issue_comments": [], "commit_comments": [], "review_comments": []}, "davepacheco": {"issues": [], "commits": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/370faf4c79ac06f4875cfb50c502728dca7cda41", "message": "shim_string_value must not return const"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/023d10a7fd48bf17b2f28c7edcef14c43b5323f6", "message": "allow JS function calls to omit rval parameter"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/593e4bd5561115faaf45e7684f7bddda62361130", "message": "add public shim_value_alloc()"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/85234b5deeb4f71c6382621e49700580afca3bb3", "message": "size_t type requires stddef.h"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/d1a453cae9584fd33233f734e385e42e93b264ab", "message": "should be able to unpack functions"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/68b18e443727cdd2ae70fc87b9dd076a2829c973", "message": "C module shouldn't have to know about C++ functions at all"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/94389b883a4dd9bc7513f8b05ff866ded7305b59", "message": "turn on all warnings and make them errors"}, {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/commits/9930c4385120eed1f17c4e54028db03bccebb02f", "message": "fix warnings on SmartOS with gcc 4.6.2"}], "pull_requests": [], "issue_comments": [], "commit_comments": [], "review_comments": []}, "tcr": {"issues": [], "commits": [], "pull_requests": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/pulls/6", "title": "Patches in the short term compatibility with <0.11.10", "body": "This is a slight rollback of the last rollback, but 0.10.18 fails with HEAD of node-addon-layer. This reverts the relevant parts for 0.10 in the short term until there's time to fix it (or I suppose drop 0.10 support).\n", "author_association": "NONE"}], "issue_comments": [], "commit_comments": [], "review_comments": []}, "vivek-kosuri": {"issues": [], "commits": [], "pull_requests": [], "issue_comments": [{"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/comments/91000967", "body": "TJ, wondering if you had a chance to look at this issue? \n", "reactions": {"url": "https://api.github.com/repos/tjfontaine/node-addon-layer/issues/comments/91000967/reactions", "total_count": 0, "+1": 0, "-1": 0, "laugh": 0, "hooray": 0, "confused": 0, "heart": 0}, "author_association": "NONE"}], "commit_comments": [], "review_comments": []}}}}